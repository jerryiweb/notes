# 多应用部署

## 前言

> 单应用如果需要设计后台或者 API 较多时，项目目录复杂，较难管理，不如一开始就采取多应用模式来得快！来得方便！

## 步骤

1. 安装 Thinkphp6
2. 安装依赖 think-multi-app
3. 调整目录结构

### 安装 Thinkphp6

```shell
composer create-project topthink/think tp6-multi-app-demo
```

### 安装依赖 think-view

```shell
composer require topthink/think-multi-app
```

### 调整目录结构

* 在 ```app\``` 目录下创建 admin、index、api 目录
* 删除 ```app\``` 目录下的 controller 目录
* 分别在 admin、index、api 目录下创建 controller config route 等目录及文件
* 修改 ```config\app.php``` 文件配置项：domain_bind、app_map、default_app
* 修改 ```config\route.php``` 文件配置项(**并手动排坑**)：url_route_must

#### 创建目录

> 分别创建多应用模式下各个应用的目录，例如

* admin
* index
* api

#### 删除目录

> 删除单应用模式下的遗留目录：```app\``` 下的 controller 目录

#### 修改配置

##### 一. 修改默认应用配置项(访问时默认应用)

> 修改 ```config\app.php``` 下的 ```default_app``` 配置项(默认为 ```index```)

```php
<?php
// +----------------------------------------------------------------------
// | 应用设置
// +----------------------------------------------------------------------
return [
    /*
     * 这里省略了一部分配置项，只展现要修改的配置项
     */
    // 默认应用
    'default_app'      => 'index',
];
```

##### 二. 修改应用映射配置项(默认访问目录需与应用目录名称一致)

> 修改 ```config\app.php``` 下的 ```app_map``` 配置项(默认为空)

```php
<?php
// +----------------------------------------------------------------------
// | 应用设置
// +----------------------------------------------------------------------
return [
    /*
     * 这里省略了一部分配置项，只展现要修改的配置项
     */
    // 应用映射（自动多应用模式有效）
    'app_map'          => [
        'think' => 'admin' // 防止他人通过 admin 目录访问后台，修改后原访问方式失效
    ],
];
```

##### 三. 修改域名绑定配置项(默认访问目录需与应用目录名称一致)

> 修改 ```config\app.php``` 下的 ```domain_bind``` 配置项(默认为空)

```php
<?php
// +----------------------------------------------------------------------
// | 应用设置
// +----------------------------------------------------------------------
return [
    /*
     * 这里省略了一部分配置项，只展现要修改的配置项
     */
    // 域名绑定（自动多应用模式有效）
    'domain_bind'      => [
        'api.djl.io' => 'api' // 修改前要把域名解析到站点
    ],
];
```

#### 开启强制路由模式

> 通过开启强制路由模式触发一大批 Bug ，解决后可以在项目中减少 Bug 产生。（ Bug 生成数因人而定，因项目而定
>
> 修改 ```config\route.php``` 下的 ```url_route_must``` 配置项(默认为 ```false```)

```php
<?php
// +----------------------------------------------------------------------
// | 路由设置
// +----------------------------------------------------------------------
return [
    /*
     * 这里省略了一部分配置项，只展现要修改的配置项
     */
    // 是否强制使用路由
    'url_route_must'        => true,
];
```

